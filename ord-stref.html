<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <title>Issues with instance Ord (STRef s a) — Christine's World Wide Web Site</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="./style.css" rel="stylesheet">
  <meta name="generator" content="soupault"></head>
  <body>
    <main>
      <article>
        <p id="author"><a href="./">@pithlessly</a> · <a href="https://github.com/pithlessly">github</a> · λ</p>
        
      <h1>Issues with <code>instance Ord (STRef s a)</code></h1>
<p><time datetime="2025-02-13">Date: 2025-02-13</time></p>
<p><code>STRef</code> is a Haskell datatype that is used to represent a mutable variable reference.
Purity is maintained by putting two restrictions on their use:</p>
<ul>
<li>Read and write operations on the reference live in a monad <code>ST</code>.</li>
<li>The function <code>runST</code> that discharges the monad has a type which enforces that
references created during evaluation of the monad are not accessible after it returns.</li>
</ul>
<p><code>STRef</code>s have an <code>Eq</code> instance, which tests equality of the references.
Occasionally someone will ask why <code>STRef</code>s don’t have an <code>Ord</code> instance that compares by address,
which would allow making a <code>Set</code> of <code>STRefs</code>.
For example:</p>
<ul>
<li><a href="https://stackoverflow.com/questions/23642126/ord-instance-of-stref">Stack Overflow</a>
— “Is there a good reason that <code>STRef</code> is not, or could not be made, an instance of either <code>Ord</code> or <code>Hashable</code> typeclasses?”</li>
<li><a href="https://www.reddit.com/r/haskell/comments/15xd1tn/why_stref_doses_not_have_an_ord_instance/">Reddit</a>
— “Why STRef doses NOT have an Ord instance?”</li>
</ul>
<p>There are some reasonable answers given in that thread.
For example, since GHC’s garbage collector can move objects around,
the address-wise comparison of <code>STRef</code>s wouldn’t be stable within a call to <code>runST</code>.</p>
<p>But the problem is actually worse than that.
Even with an implementation where the garbage collector never moved objects around,
exposing pointer comparison would allow the creation of impure functions:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode hs"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ot">f ::</span> () <span class="ot">-&gt;</span> <span class="dt">Bool</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>f () <span class="ot">=</span> runST (<span class="kw">do</span> r1 <span class="ot">&lt;-</span> newSTRef <span class="dv">0</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>                 r2 <span class="ot">&lt;-</span> newSTRef <span class="dv">0</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">return</span> (r1 <span class="op">&lt;</span> r2))</span></code></pre></div>
<p>The comparison could be succeed on the first invocation of <code>f</code> and fail on a subsequent one.</p>
</article>
      <footer>
      <div>
  <a href="https://soupault.app/"><img src="./buttons/powered-by-soupault.png"></a>
  <img src="./buttons/bookmark_this_page.gif">
  <img src="./buttons/trans-flag.png">
  <img src="./buttons/ace-flag.png">
  <img src="./buttons/firefox.gif">
  <img src="./buttons/fediverse.gif" class="sharp">
  <img src="./buttons/i-was-on-cohost.webp">
  <a href="https://tailscale.com/"><img src="./buttons/tailscale.png"></a>
  <a href="https://bitwarden.com/"><img src="./buttons/bitwarden.gif" class="sharp"></a>
  <a href="https://haskell.org"><img src="./buttons/haskell.png"></a>
  <img src="./buttons/linux.gif">
  <img src="./buttons/sun.gif">
  <a href="https://archive.org/"><img src="./buttons/internetarchive.gif"></a>
  <img src="./buttons/antinft.gif">
  <img src="./buttons/iso8601.png">
</div>
<br>
<div>
  <a href="https://roseiverse.com"><img src="https://roseiverse.com/buttons/roseiverse.png" width="88" height="31"></a>
  <a href="https://fireis.dev/"><img src="./buttons/fireisgood.png" style="outline:1px solid black;"></a>
  <a href="https://razetime.github.io/"><img src="./buttons/razetime.png"></a>
  <a href="https://razetime.github.io/"><img src="./buttons/allzetime.png"></a>
</div>
</footer>
    </main>
  

</body></html>